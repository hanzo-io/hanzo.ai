{"version":3,"file":"rollup-plugin-node-resolve-magic.mjs","sources":["../src/index.coffee"],"sourcesContent":["import fs             from 'fs'\nimport path           from 'path'\nimport builtins       from 'builtin-modules'\nimport browserResolve from 'browser-resolve'\nimport nodeResolve    from 'resolve'\nimport chalk          from 'chalk'\n\nCOMMONJS_BROWSER_EMPTY = nodeResolve.sync 'browser-resolve/empty.js', __dirname\nES6_BROWSER_EMPTY      = path.resolve __dirname, '../src/empty.js'\n\n\nnodeResolveMagic = (opts = {}) ->\n  basedir        = opts.basedir        ? null\n  browser        = opts.browser        ? false\n  extensions     = opts.extensions     ? ['.js', '.coffee', '.json']\n  external       = opts.external       ? true\n  paths          = opts.paths          ? []\n  preferBuiltins = opts.preferBuiltins ? true\n  skip           = opts.skip           ? []\n\n  if basedir?\n    paths.push basedir\n\n  if Array.isArray opts.external\n    external = false\n    skip     = skip.concat opts.external\n\n  skip = new Set skip\n\n  resolveId = if browser then browserResolve else nodeResolve\n\n  packageFilter = (pkg) ->\n    # Try in order: 'module', 'jsnext:main' and 'main' fields. Fall back to\n    # index.js if path to entry module is unspecified.\n    if pkg.module\n      pkg.main = pkg.module\n    else if pkg['jsnext:main']\n      pkg.main = pkg['jsnext:main']\n    unless pkg.main\n      pkg.main = './index.js'\n\n    # Automatically detect new externals based on package.json if opts.\n    # Typically a bundled library will only include dependencies which\n    # have not been processed into the build for some reason. We'll\n    # likewise defer processing these (unless forced)\n    if external == true and pkg.module?\n      for k of pkg.dependencies\n        continue if skip.has k\n        skip.add k\n        console.log \" - #{k}\" + chalk.black \" detected as external to #{pkg.name}\"\n      for k of pkg.peerDependencies\n        continue if skip.has k\n        skip.add k\n        console.log \" - #{k}\" + chalk.black \" detected as external to #{pkg.name}\"\n\n    pkg\n\n  name: 'node-resolve-magic'\n  resolveId: (importee, importer) ->\n    return null if /\\0/.test importee # Ignore IDs with null character, these belong to other plugins\n    return null if !importer          # Disregard entry module\n\n    parts = importee.split /[\\/\\\\]/\n    id    = parts.shift()\n\n    if id[0] == '@' && parts.length\n      # scoped packages\n      id += \"/#{parts.shift()}\"\n    else if id[0] == '.'\n      # An import relative to the parent dir of the importer\n      id = path.resolve importer, '..', importee\n\n    return if skip.has id\n\n    new Promise (resolve, reject) ->\n      resolveOpts =\n        # If this is a relative require, use the importer as the base,\n        # otherwise project basedir should be used to prevent unnecessary\n        # duplication of modules\n        basedir:       if importee[0] == '.' then path.dirname importer else basedir\n        paths:         paths\n        extensions:    extensions\n        packageFilter: packageFilter\n\n      resolveId importee, resolveOpts, (err, resolved) ->\n        if err?\n          return reject new Error \"Could not resolve '#{importee}' from #{path.normalize importer}\"\n\n        # Empty modules?\n        if resolved == COMMONJS_BROWSER_EMPTY\n          return resolve ES6_BROWSER_EMPTY\n\n        # Built-in module previously resolved?\n        if ~builtins.indexOf resolved\n          return resolve null\n\n        # Prefer built-ins\n        if preferBuiltins and ~builtins.indexOf importee\n          unless opts.quiet\n            console.log \" - #{importee}\" + chalk.black \" built-in preferred over local alternative\"\n            skip.add importee\n          return resolve null\n\n        # Resolve symlinks\n        fs.exists resolved, (exists) ->\n          unless exists\n            unless opts.quiet\n              console.log \"resolved #{importee} to #{resolved}, which does not exist\"\n            return resolve null\n\n          fs.realpath resolved, (err, resolved) ->\n            return reject err if err?\n\n            resolve resolved\n\nnodeResolveMagic.browser = browserResolve\nnodeResolveMagic.node    = nodeResolve\n\nexport default nodeResolveMagic\n"],"names":[],"mappings":";;;;;;;;AAAA,IAAA;;;;AAAA,AACA,AACA,AACA,AACA,AACA,AAEA,sBAAA,GAAyB,WAAW,CAAC,IAAZ,CAAiB,0BAAjB,EAA6C,SAA7C;;AACzB,iBAAA,GAAyB,IAAI,CAAC,OAAL,CAAa,SAAb,EAAwB,iBAAxB;;AAGzB,gBAAA,GAAmB,SAAC,IAAD;MACjB;;IADkB,OAAO;;EACzB,OAAA,wCAAuC;EACvC,OAAA,0CAAuC;EACvC,UAAA,6CAAuC,CAAC,KAAD,EAAQ,SAAR,EAAmB,OAAnB;EACvC,QAAA,2CAAuC;EACvC,KAAA,wCAAuC;EACvC,cAAA,iDAAuC;EACvC,IAAA,uCAAuC;EAEvC,IAAG,eAAH;IACE,KAAK,CAAC,IAAN,CAAW,OAAX,EADF;;EAGA,IAAG,KAAK,CAAC,OAAN,CAAc,IAAI,CAAC,QAAnB,CAAH;IACE,QAAA,GAAW;IACX,IAAA,GAAW,IAAI,CAAC,MAAL,CAAY,IAAI,CAAC,QAAjB,EAFb;;EAIA,IAAA,GAAO,IAAI,GAAJ,CAAQ,IAAR;EAEP,SAAA,GAAe,OAAH,GAAgB,cAAhB,GAAoC;EAEhD,aAAA,GAAgB,SAAC,GAAD;QAGd;IAAA,IAAG,GAAG,CAAC,MAAP;MACE,GAAG,CAAC,IAAJ,GAAW,GAAG,CAAC,OADjB;KAAA,MAEK,IAAG,GAAI,CAAA,aAAA,CAAP;MACH,GAAG,CAAC,IAAJ,GAAW,GAAI,CAAA,aAAA,EADZ;;IAEL,IAAA,CAAO,GAAG,CAAC,IAAX;MACE,GAAG,CAAC,IAAJ,GAAW,aADb;;IAOA,IAAG,QAAA,KAAY,IAAZ,wBAAH;WACE,qBAAA;QACE,IAAY,IAAI,CAAC,GAAL,CAAS,CAAT,CAAZ;mBAAA;;QACA,IAAI,CAAC,GAAL,CAAS,CAAT;QACA,OAAO,CAAC,GAAR,CAAY,CAAA,KAAA,GAAM,CAAN,IAAY,KAAK,CAAC,KAAN,CAAY,2BAAA,GAA4B,GAAG,CAAC,IAA5C,CAAxB;;WACF,yBAAA;QACE,IAAY,IAAI,CAAC,GAAL,CAAS,CAAT,CAAZ;mBAAA;;QACA,IAAI,CAAC,GAAL,CAAS,CAAT;QACA,OAAO,CAAC,GAAR,CAAY,CAAA,KAAA,GAAM,CAAN,IAAY,KAAK,CAAC,KAAN,CAAY,2BAAA,GAA4B,GAAG,CAAC,IAA5C,CAAxB;OARJ;;WAUA;;SAEF;IAAA,IAAA,EAAM,oBAAN;IACA,SAAA,EAAW,SAAC,QAAD,EAAW,QAAX;UACT;MAAA,IAAe,IAAI,CAAC,IAAL,CAAU,QAAV,CAAf;eAAO,KAAP;;MACA,IAAe,CAAC,QAAhB;eAAO,KAAP;;MAEA,KAAA,GAAQ,QAAQ,CAAC,KAAT,CAAe,QAAf;MACR,EAAA,GAAQ,KAAK,CAAC,KAAN;MAER,IAAG,EAAG,CAAA,CAAA,CAAH,KAAS,GAAT,IAAgB,KAAK,CAAC,MAAzB;QAEE,EAAA,IAAM,GAAA,IAAI,KAAK,CAAC,KAAN,EAAD,EAFX;OAAA,MAGK,IAAG,EAAG,CAAA,CAAA,CAAH,KAAS,GAAZ;QAEH,EAAA,GAAK,IAAI,CAAC,OAAL,CAAa,QAAb,EAAuB,IAAvB,EAA6B,QAA7B,EAFF;;MAIL,IAAU,IAAI,CAAC,GAAL,CAAS,EAAT,CAAV;eAAA;;aAEA,IAAI,OAAJ,CAAY,SAAC,OAAD,EAAU,MAAV;YACV;QAAA,WAAA,GAIE;UAAA,OAAA,EAAkB,QAAS,CAAA,CAAA,CAAT,KAAe,GAAlB,GAA2B,IAAI,CAAC,OAAL,CAAa,QAAb,CAA3B,GAAsD,OAArE;UACA,KAAA,EAAe,KADf;UAEA,UAAA,EAAe,UAFf;UAGA,aAAA,EAAe,aAHf;;eAKF,SAAA,CAAU,QAAV,EAAoB,WAApB,EAAiC,SAAC,GAAD,EAAM,QAAN;UAC/B,IAAG,WAAH;mBACS,MAAA,CAAO,IAAI,KAAJ,CAAU,qBAAA,GAAsB,QAAtB,GAA+B,SAA/B,IAAwC,IAAI,CAAC,SAAL,CAAe,QAAf,CAAD,CAAjD,CAAP,EADT;;UAIA,IAAG,QAAA,KAAY,sBAAf;mBACS,OAAA,CAAQ,iBAAR,EADT;;UAIA,IAAG,CAAC,QAAQ,CAAC,OAAT,CAAiB,QAAjB,CAAJ;mBACS,OAAA,CAAQ,IAAR,EADT;;UAIA,IAAG,cAAA,IAAmB,CAAC,QAAQ,CAAC,OAAT,CAAiB,QAAjB,CAAvB;YACE,IAAA,CAAO,IAAI,CAAC,KAAZ;cACE,OAAO,CAAC,GAAR,CAAY,CAAA,KAAA,GAAM,QAAN,IAAmB,KAAK,CAAC,KAAN,CAAY,4CAAZ,CAA/B;cACA,IAAI,CAAC,GAAL,CAAS,QAAT,EAFF;;mBAGO,OAAA,CAAQ,IAAR,EAJT;;iBAOA,EAAE,CAAC,MAAH,CAAU,QAAV,EAAoB,SAAC,MAAD;YAClB,IAAA,CAAO,MAAP;cACE,IAAA,CAAO,IAAI,CAAC,KAAZ;gBACE,OAAO,CAAC,GAAR,CAAY,WAAA,GAAY,QAAZ,GAAqB,MAArB,GAA2B,QAA3B,GAAoC,wBAAhD,EADF;;qBAEO,OAAA,CAAQ,IAAR,EAHT;;mBAKA,EAAE,CAAC,QAAH,CAAY,QAAZ,EAAsB,SAAC,GAAD,EAAM,QAAN;cACpB,IAAqB,WAArB;uBAAO,MAAA,CAAO,GAAP,EAAP;;qBAEA,OAAA,CAAQ,QAAR;aAHF;WANF;SApBF;OAVF;KAjBF;;;;AA0DF,gBAAgB,CAAC,OAAjB,GAA2B;;AAC3B,gBAAgB,CAAC,IAAjB,GAA2B;;AAE3B,yBAAe;;"}